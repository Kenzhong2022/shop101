# 如何使用数据库

## 概述

本项目使用 **Neon PostgreSQL** 作为数据库服务，通过 `@neondatabase/serverless` 包提供的 `neon` 函数进行连接和操作。数据库连接配置通过环境变量管理，支持自动连接验证和表结构检查。

## 一、需要下载的内容

### 1. 依赖包（已安装）
```json
{
  "@neondatabase/serverless": "^1.0.2",
  "@netlify/neon": "^0.1.0"
}
```

### 2. 环境变量配置
需要在项目根目录创建 `.env` 文件，添加以下变量：

```env
# Neon PostgreSQL 数据库连接地址
NUXT_NEON_DATABASE_URL=postgresql://用户名:密码@主机地址:端口/数据库名?sslmode=require

# 可选：传统 MySQL 配置（项目兼容）
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=your_database
DB_PORT=3306
```

> ⚠️ 注意：`.env` 文件已添加到 `.gitignore`，不会提交到代码仓库

## 二、涉及的文件

### 1. 核心数据库工具
- **<mcfile name="neon.js" path="d:\shop101\server\utils\neon.js"></mcfile>**：数据库连接和初始化工具
  - 自动验证数据库连接
  - 列出 public schema 中的所有表
  - 导出 `getNeon()` 函数供其他文件使用

### 2. 配置文件
- **<mcfile name="nuxt.config.js" path="d:\shop101\nuxt.config.js"></mcfile>**：环境变量配置
  ```javascript
  runtimeConfig: {
    NUXT_NEON_DATABASE_URL: process.env.NUXT_NEON_DATABASE_URL,
    DB_HOST: process.env.DB_HOST,
    DB_USER: process.env.DB_USER,
    DB_PASSWORD: process.env.DB_PASSWORD,
    DB_NAME: process.env.DB_NAME,
    DB_PORT: process.env.DB_PORT || 3306,
  }
  ```

### 3. 使用数据库的 API 文件
- **<mcfile name="register.post.ts" path="d:\shop101\server\api\register.post.ts"></mcfile>**：用户注册
- **<mcfile name="login2.post.ts" path="d:\shop101\server\api\login2.post.ts"></mcfile>**：用户登录
- **<mcfile name="search.post.ts" path="d:\shop101\server\api\friends\search.post.ts"></mcfile>**：搜索好友
- **<mcfile name="chatRecords.post.ts" path="d:\shop101\server\api\friends\chatRecords.post.ts"></mcfile>**：获取聊天记录
- **<mcfile name="add.post.ts" path="d:\shop101\server\api\friends\add.post.ts"></mcfile>**：添加好友

### 4. 数据库插件
- **<mcfile name="socket.io.js" path="d:\shop101\server\plugins\socket.io.js"></mcfile>**：Socket.io 插件中使用数据库

## 三、数据库表结构

### 1. users 表（用户表）
```sql
-- 根据 register.post.ts 中的插入语句推断
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL
);
```

### 2. 其他表
项目中还涉及以下表（具体结构需查看数据库）：
- 好友关系表
- 聊天记录表
- 聊天室参与者表（chat_participant）

## 四、使用方法

### 1. 基本使用步骤

#### 步骤 1：获取数据库连接
```javascript
import getNeon from "~~/server/utils/neon";
const mySql = getNeon(); // 获取数据库连接实例
```

#### 步骤 2：执行 SQL 查询
```javascript
// 查询示例
const [userRows] = await mySql`SELECT id FROM users WHERE username = ${username}`;

// 插入示例
await mySql`
  INSERT INTO users (username, email, password)
  VALUES (${username}, ${email}, ${hashedPassword})
`;

// 复杂查询示例
const users = await mySql`
  SELECT * FROM users 
  WHERE username LIKE ${'%' + searchKeyword + '%'}
  ORDER BY username
  LIMIT ${limit} OFFSET ${offset}
`;
```

### 2. 实际应用示例

#### 用户注册（register.post.ts）
```javascript
// 检查用户名是否存在
const [userRows] = await mySql`SELECT id FROM users WHERE username = ${username}`;

// 检查邮箱是否存在
const [emailRows] = await mySql`SELECT id FROM users WHERE email = ${email}`;

// 插入新用户
await mySql`
  INSERT INTO users (username, email, password)
  VALUES (${username}, ${email}, ${hashedPassword})
`;
```

#### 用户登录（login2.post.ts）
```javascript
// 查询用户信息
const [rows] = await mySql`
  SELECT id, email, username, password FROM "users" 
  WHERE email = ${email} LIMIT 1
`;
```

#### 搜索好友（search.post.ts）
```javascript
// 搜索用户
const users = await mySql`
  SELECT * FROM users 
  WHERE username LIKE ${'%' + searchKeyword + '%'}
  ORDER BY username
`;
```

#### 获取聊天记录（chatRecords.post.ts）
```javascript
// 查询聊天室ID
const [roomRows] = await mySql`
  SELECT cp.room_id 
  FROM chat_participant cp
  WHERE cp.user_id IN (${userId}, ${friendId})
  GROUP BY cp.room_id
  HAVING COUNT(DISTINCT cp.user_id) = 2
  LIMIT 1
`;

// 查询聊天记录
const chatRows = await mySql`
  SELECT * FROM chat_messages 
  WHERE room_id = ${roomId} 
  ORDER BY created_at DESC 
  LIMIT ${limit}
`;
```

## 五、环境变量配置详解

### 1. Neon 数据库 URL 格式
```
postgresql://[用户名]:[密码]@[主机地址]:[端口]/[数据库名]?sslmode=require
```

### 2. 获取 Neon 数据库 URL
1. 访问 [Neon 官网](https://neon.tech)
2. 创建项目并获取数据库连接字符串
3. 将连接字符串复制到 `.env` 文件的 `NUXT_NEON_DATABASE_URL` 变量中

### 3. 环境变量安全提示
- 不要将 `.env` 文件提交到代码仓库
- 在生产环境中使用强密码
- 定期轮换数据库凭据

## 六、调试和排错

### 1. 启动时自动检查
数据库连接工具会在项目启动时自动：
- 验证数据库连接
- 显示数据库版本信息
- 列出所有用户表

### 2. 常见错误及解决方案

#### 错误：未配置 NUXT_NEON_DATABASE_URL
```
❌ 未配置 NUXT_NEON_DATABASE_URL 环境变量
```
**解决方案**：在 `.env` 文件中添加正确的数据库连接地址

#### 错误：数据库连接失败
```
❌ 数据库连接失败！
```
**解决方案**：
1. 检查网络连接
2. 验证数据库凭据是否正确
3. 确认数据库服务是否运行
4. 检查防火墙设置

#### 错误：表不存在
```
⚠️ 当前数据库 public Schema 中暂无用户创建的表
```
**解决方案**：需要创建相应的数据库表结构

### 3. 日志输出说明
启动时会输出以下信息：
```
🔍 正在验证数据库连接...
📊 数据库URL: postgresql://用户名:***@主机地址:端口/数据库名?sslmode=require
✅ 数据库连接成功！
📌 数据库版本: PostgreSQL 15.x on x86_64-pc-linux-gnu...

📋 数据库中存在的表（public Schema）:
共发现 X 个表：
  1. 表名：users（类型：BASE TABLE）
  2. 表名：friends（类型：BASE TABLE）
  ...
```

## 七、最佳实践

### 1. SQL 注入防护
- 始终使用模板字符串语法：`await mySql\`SELECT * FROM users WHERE id = \({userId}\)`
- 不要直接拼接 SQL 字符串

### 2. 错误处理
```javascript
try {
  const result = await mySql\`SELECT * FROM users WHERE id = \){userId}\`;
  return result;
} catch (error) {
  console.error("数据库查询失败:", error.message);
  throw createError({
    statusCode: 500,
    statusMessage: "数据库查询失败"
  });
}
```

### 3. 连接池管理
- 使用 `getNeon()` 获取连接实例，不要重复创建连接
- 连接实例可以安全地在多个请求间共享

### 4. 性能优化
- 为常用查询字段添加索引
- 使用 LIMIT 限制返回结果数量
- 避免在循环中执行数据库查询

## 八、扩展功能

### 1. 数据库迁移
可以考虑添加数据库迁移工具，如：
- Prisma Migrate
- node-pg-migrate
- db-migrate

### 2. 数据库备份
定期备份数据库，可以使用：
- Neon 提供的自动备份功能
- 自定义备份脚本

### 3. 监控和告警
- 设置数据库性能监控
- 配置错误告警机制
- 监控连接池状态

---

通过以上配置和使用方法，你可以顺利地在项目中使用 Neon PostgreSQL 数据库。如遇到问题，请检查环境变量配置和网络连接状态。