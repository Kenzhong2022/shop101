# ğŸ” é‰´æƒæŒ‡å— - HMAC ç­¾åéªŒè¯å®Œæ•´æµç¨‹

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [ç­¾åç”Ÿæˆæµç¨‹](#ç­¾åç”Ÿæˆæµç¨‹)
4. [ç­¾åéªŒè¯æµç¨‹](#ç­¾åéªŒè¯æµç¨‹)
5. [å®‰å…¨ç‰¹æ€§](#å®‰å…¨ç‰¹æ€§)
6. [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯)
7. [ä»£ç å®ç°è¯¦è§£](#ä»£ç å®ç°è¯¦è§£)
8. [å¸¸è§ç­¾åæƒ…å†µåˆ†æ](#å¸¸è§ç­¾åæƒ…å†µåˆ†æ)
9. [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿°åŸºäº HMAC-SHA256 çš„ç­¾åéªŒè¯æœºåˆ¶ï¼Œç”¨äºç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€èº«ä»½éªŒè¯å’Œé˜²ç¯¡æ”¹ä¿æŠ¤ã€‚è¯¥æœºåˆ¶å¹¿æ³›åº”ç”¨äº API æ¥å£å®‰å…¨ã€æ•°æ®ä¼ è¾“éªŒè¯ç­‰åœºæ™¯ã€‚

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µ

### HMAC (Hash-based Message Authentication Code)

- **å®šä¹‰**ï¼šåŸºäºå“ˆå¸Œå‡½æ•°çš„æ¶ˆæ¯è®¤è¯ç 
- **ç®—æ³•**ï¼šHMAC-SHA256
- **ç‰¹ç‚¹**ï¼šéœ€è¦å¯†é’¥å‚ä¸è®¡ç®—ï¼Œæä¾›èº«ä»½éªŒè¯åŠŸèƒ½

### å…³é”®è¦ç´ 

```typescript
interface SignatureElements {
  info: string; // åŸå§‹ä¿¡æ¯ï¼ˆéœ€è¦ä¿æŠ¤çš„æ•°æ®ï¼‰
  key: string; // å¯†é’¥ï¼ˆåªæœ‰é€šä¿¡åŒæ–¹çŸ¥é“ï¼‰
  signature: string; // ç”Ÿæˆçš„ç­¾åï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
}
```

## ğŸ“ ç­¾åç”Ÿæˆæµç¨‹

### æ­¥éª¤è¯¦è§£

```mermaid
graph TD
    A[åŸå§‹ä¿¡æ¯ info] -->|è¾“å…¥| B[HMAC-SHA256ç®—æ³•]
    C[å¯†é’¥ key] -->|è¾“å…¥| B
    B -->|è®¡ç®—ç»“æœ| D[äºŒè¿›åˆ¶å“ˆå¸Œå€¼]
    D -->|digest\("hex"\)| E[åå…­è¿›åˆ¶ç­¾å signature]
```

### ä»£ç å®ç°

```typescript
function generateSignature(info: string, key: string): string {
  return crypto.createHmac("sha256", key).update(info).digest("hex");
}
```

### ç¤ºä¾‹

```typescript
const info = "user123:login:2024-01-01";
const key = "my_secret_key_2024";
const signature = generateSignature(info, key);
// è¾“å‡º: "a1b2c3d4e5f6..." (64ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²)
```

## âœ… ç­¾åéªŒè¯æµç¨‹

### éªŒè¯æ­¥éª¤

```mermaid
graph TD
    A[æ”¶åˆ°æ•°æ®] --> B{æå–ä¿¡æ¯}
    B --> C[åŸå§‹ä¿¡æ¯ info]
    B --> D[æä¾›çš„ç­¾å providedSignature]
    C --> E[ä½¿ç”¨å¯†é’¥é‡æ–°ç”Ÿæˆç­¾å]
    D --> F[è½¬æ¢ç­¾åä¸ºBuffer]
    E --> G[è½¬æ¢æ–°ç­¾åä¸ºBuffer]
    F --> H{æ¯”è¾ƒç­¾å}
    G --> H
    H -->|é•¿åº¦ä¸åŒ| I[éªŒè¯å¤±è´¥]
    H -->|é•¿åº¦ç›¸åŒ| J[timingSafeEqualæ¯”è¾ƒ]
    J -->|ç›¸ç­‰| K[éªŒè¯æˆåŠŸ]
    J -->|ä¸ç›¸ç­‰| L[éªŒè¯å¤±è´¥]
```

### å®Œæ•´éªŒè¯å‡½æ•°

```typescript
function verifySignature(
  info: string,
  key: string,
  providedSignature: string
): boolean {
  // 1. é‡æ–°ç”ŸæˆæœŸæœ›çš„ç­¾å
  const expectedSignature = generateSignature(info, key);

  // 2. è½¬æ¢ä¸ºBufferè¿›è¡Œå®‰å…¨æ¯”è¾ƒ
  const expectedBuffer = Buffer.from(expectedSignature, "hex");
  const providedBuffer = Buffer.from(providedSignature, "hex");

  // 3. é•¿åº¦æ£€æŸ¥ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
  if (expectedBuffer.length !== providedBuffer.length) {
    return false;
  }

  // 4. å®‰å…¨æ¯”è¾ƒï¼ˆé˜²æ—¶åºæ”»å‡»ï¼‰
  return crypto.timingSafeEqual(expectedBuffer, providedBuffer);
}
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. æ•°æ®å®Œæ•´æ€§ä¿æŠ¤

- **ä½œç”¨**ï¼šç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æœªè¢«ç¯¡æ”¹
- **åŸç†**ï¼šä»»ä½•æ•°æ®ä¿®æ”¹éƒ½ä¼šå¯¼è‡´ç­¾åéªŒè¯å¤±è´¥

### 2. èº«ä»½éªŒè¯

- **ä½œç”¨**ï¼šéªŒè¯é€šä¿¡åŒæ–¹çš„èº«ä»½
- **åŸç†**ï¼šåªæœ‰æ‹¥æœ‰æ­£ç¡®å¯†é’¥çš„ä¸€æ–¹æ‰èƒ½ç”Ÿæˆæœ‰æ•ˆç­¾å

### 3. é˜²æ—¶åºæ”»å‡»

- **å¨èƒ**ï¼šæ”»å‡»è€…é€šè¿‡æµ‹é‡å“åº”æ—¶é—´å·®å¼‚æ¥çŒœæµ‹æ­£ç¡®ç­¾å
- **é˜²æŠ¤**ï¼š`crypto.timingSafeEqual()`ç¡®ä¿æ¯”è¾ƒæ—¶é—´æ’å®š

### 4. ä¸å¯æŠµèµ–æ€§

- **ä½œç”¨**ï¼šç­¾åæ–¹æ— æ³•å¦è®¤ç”Ÿæˆè¿‡è¯¥ç­¾å
- **åŸç†**ï¼šåªæœ‰çŸ¥é“å¯†é’¥æ‰èƒ½ç”Ÿæˆæœ‰æ•ˆç­¾å

## ğŸ® å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šAPI è¯·æ±‚éªŒè¯

```typescript
// å®¢æˆ·ç«¯
const timestamp = Date.now();
const data = { userId: 123, action: "buy", amount: 100 };
const signature = generateSignature(
  JSON.stringify(data) + timestamp,
  secretKey
);

// å‘é€è¯·æ±‚
fetch("/api/buy", {
  method: "POST",
  headers: {
    "X-Signature": signature,
    "X-Timestamp": timestamp,
  },
  body: JSON.stringify(data),
});

// æœåŠ¡ç«¯éªŒè¯
const isValid = verifySignature(
  JSON.stringify(req.body) + req.headers["x-timestamp"],
  secretKey,
  req.headers["x-signature"]
);
```

### åœºæ™¯ 2ï¼šJWT ä»¤ç‰Œå¢å¼º

```typescript
// ç”Ÿæˆå¸¦ç­¾åçš„JWTè½½è·
const payload = {
  userId: user.id,
  role: user.role,
  timestamp: Date.now(),
};

const signature = generateSignature(JSON.stringify(payload), jwtSecret);
const token = btoa(JSON.stringify(payload)) + "." + signature; // ç¼–ç ä¸ºBase64
```

### åœºæ™¯ 3ï¼šæ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ

```typescript
// ä¸Šä¼ æ–‡ä»¶æ—¶ç”Ÿæˆç­¾å
const fileHash = await calculateFileHash(file);
const signature = generateSignature(fileHash, serverSecret);

// ä¸‹è½½æ—¶éªŒè¯
const isValid = verifySignature(
  calculatedHash,
  serverSecret,
  providedSignature
);
```

## ğŸ’» ä»£ç å®ç°è¯¦è§£

### å®Œæ•´å®ç°ä»£ç 

```typescript
import crypto from "node:crypto";

/**
 * ç”ŸæˆHMACç­¾å
 * @param info - è¦ç­¾åçš„ä¿¡æ¯
 * @param key - ç­¾åå¯†é’¥
 * @returns HMACç­¾åç»“æœï¼ˆ64ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
 */
function generateSignature(info: string, key: string): string {
  return crypto.createHmac("sha256", key).update(info).digest("hex");
}

/**
 * éªŒè¯HMACç­¾å
 * @param info - åŸå§‹ä¿¡æ¯
 * @param key - ç­¾åå¯†é’¥
 * @param providedSignature - æä¾›çš„ç­¾å
 * @returns ç­¾åæ˜¯å¦æœ‰æ•ˆ
 */
function verifySignature(
  info: string,
  key: string,
  providedSignature: string
): boolean {
  // ç”ŸæˆæœŸæœ›çš„ç­¾å
  const expectedSignature = generateSignature(info, key);

  // è½¬æ¢ä¸ºBufferè¿›è¡Œå®‰å…¨æ¯”è¾ƒ
  const expectedBuffer = Buffer.from(expectedSignature, "hex");
  const providedBuffer = Buffer.from(providedSignature, "hex");

  // å¿«é€Ÿé•¿åº¦æ£€æŸ¥
  if (expectedBuffer.length !== providedBuffer.length) {
    return false;
  }

  // ä½¿ç”¨timingSafeEqualé˜²æ­¢æ—¶åºæ”»å‡»
  return crypto.timingSafeEqual(expectedBuffer, providedBuffer);
}
```

## ğŸ” å¸¸è§ç­¾åæƒ…å†µåˆ†æ

### æƒ…å†µ 1ï¼šç­¾åæ­£ç¡® âœ…

```typescript
const info = "hello";
const key = "123456";
const signature = generateSignature(info, key); // "2cf24dba..."
const isValid = verifySignature(info, key, signature); // true
```

**ç»“æœ**ï¼šéªŒè¯é€šè¿‡ï¼Œæ•°æ®å¯ä¿¡

### æƒ…å†µ 2ï¼šç­¾åè¢«ç¯¡æ”¹ âŒ

```typescript
const tamperedSignature = "wrong_signature_12345";
const isValid = verifySignature(info, key, tamperedSignature); // false
```

**ç»“æœ**ï¼šéªŒè¯å¤±è´¥ï¼Œç­¾åæ— æ•ˆ

### æƒ…å†µ 3ï¼šåŸå§‹ä¿¡æ¯è¢«ç¯¡æ”¹ âŒ

```typescript
const isValid = verifySignature("hello_modified", key, signature); // false
```

**ç»“æœ**ï¼šéªŒè¯å¤±è´¥ï¼Œæ•°æ®è¢«ç¯¡æ”¹

### æƒ…å†µ 4ï¼šå¯†é’¥é”™è¯¯ âŒ

```typescript
const isValid = verifySignature(info, "wrong_key", signature); // false
```

**ç»“æœ**ï¼šéªŒè¯å¤±è´¥ï¼Œèº«ä»½éªŒè¯ä¸é€šè¿‡

### æƒ…å†µ 5ï¼šç­¾åé•¿åº¦ä¸åŒ¹é… âŒ

```typescript
const shortSignature = "abc123";
const isValid = verifySignature(info, key, shortSignature); // false
```

**ç»“æœ**ï¼šå¿«é€Ÿå¤±è´¥ï¼Œç­¾åæ ¼å¼é”™è¯¯

## ğŸš€ æœ€ä½³å®è·µå»ºè®®

### 1. å¯†é’¥ç®¡ç†

```typescript
// âœ… æ¨èï¼šç¯å¢ƒå˜é‡å­˜å‚¨
const secretKey = process.env.HMAC_SECRET_KEY;

// âŒ é¿å…ï¼šç¡¬ç¼–ç å¯†é’¥
const secretKey = "my_fixed_secret_key_12345";
```

### 2. å¯†é’¥è½®æ¢

```typescript
// å®ç°å¯†é’¥ç‰ˆæœ¬æ§åˆ¶
const keyVersions = {
  v1: process.env.HMAC_KEY_V1, // æ—§å¯†é’¥
  v2: process.env.HMAC_KEY_V2, // æ–°å¯†é’¥
};

// éªŒè¯æ—¶å°è¯•å¤šä¸ªå¯†é’¥ç‰ˆæœ¬
function verifyWithKeyRotation(info: string, signature: string): boolean {
  return Object.values(keyVersions).some((key) =>
    verifySignature(info, key, signature)
  );
}
```

### 3. æ·»åŠ æ—¶é—´æˆ³é˜²é‡æ”¾

```typescript
function createSecureSignature(
  data: any,
  key: string
): { signature: string; timestamp: number } {
  const timestamp = Date.now();
  const signature = generateSignature(JSON.stringify(data) + timestamp, key);
  return { signature, timestamp };
}

function verifySecureSignature(
  data: any,
  key: string,
  signature: string,
  timestamp: number
): boolean {
  // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ5åˆ†é’Ÿï¼‰
  const now = Date.now();
  if (Math.abs(now - timestamp) > 5 * 60 * 1000) {
    return false; // è¯·æ±‚è¿‡æœŸ
  }

  return verifySignature(JSON.stringify(data) + timestamp, key, signature);
}
```

### 4. é”™è¯¯å¤„ç†

```typescript
function safeVerifySignature(
  info: string,
  key: string,
  signature: string
): boolean {
  try {
    // è¾“å…¥éªŒè¯
    if (!info || !key || !signature) {
      return false;
    }

    // ç­¾åæ ¼å¼éªŒè¯
    if (!/^[a-f0-9]{64}$/i.test(signature)) {
      return false;
    }

    return verifySignature(info, key, signature);
  } catch (error) {
    console.error("ç­¾åéªŒè¯é”™è¯¯:", error);
    return false;
  }
}
```

### 5. æ€§èƒ½ä¼˜åŒ–

```typescript
// ç¼“å­˜å¸¸ç”¨ç­¾åï¼ˆé€‚ç”¨äºé‡å¤æ•°æ®ï¼‰
const signatureCache = new Map<string, string>();

function generateCachedSignature(info: string, key: string): string {
  const cacheKey = `${info}:${key}`;

  if (signatureCache.has(cacheKey)) {
    return signatureCache.get(cacheKey)!;
  }

  const signature = generateSignature(info, key);
  signatureCache.set(cacheKey, signature);

  return signature;
}
```

## ğŸ“Š æ€§èƒ½ä¸å®‰å…¨å¯¹æ¯”

| æ–¹æ¡ˆ        | å®‰å…¨æ€§     | æ€§èƒ½       | é€‚ç”¨åœºæ™¯               |
| ----------- | ---------- | ---------- | ---------------------- |
| HMAC-SHA256 | â­â­â­â­â­ | â­â­â­â­   | API éªŒè¯ã€æ•°æ®å®Œæ•´æ€§   |
| RSA ç­¾å    | â­â­â­â­â­ | â­â­       | æ•°å­—è¯ä¹¦ã€æ³•å¾‹æ–‡ä»¶     |
| MD5 å“ˆå¸Œ    | â­â­       | â­â­â­â­â­ | æ–‡ä»¶æ ¡éªŒï¼ˆéå®‰å…¨åœºæ™¯ï¼‰ |
| çº¯ SHA256   | â­â­â­     | â­â­â­â­   | æ•°æ®æŒ‡çº¹ï¼ˆæ— å¯†é’¥ï¼‰     |

## ğŸ¯ æ€»ç»“

HMAC-SHA256 ç­¾åéªŒè¯æœºåˆ¶æä¾›äº†ï¼š

- **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿æ•°æ®æœªè¢«ç¯¡æ”¹
- **èº«ä»½éªŒè¯**ï¼šéªŒè¯é€šä¿¡åŒæ–¹èº«ä»½
- **é˜²æ—¶åºæ”»å‡»**ï¼šä½¿ç”¨å®‰å…¨æ¯”è¾ƒæ–¹æ³•
- **é«˜æ€§èƒ½**ï¼šè®¡ç®—é€Ÿåº¦å¿«ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯
- **æ˜“å®ç°**ï¼šä»£ç ç®€æ´ï¼Œæ˜“äºé›†æˆ

é€šè¿‡åˆç†ä½¿ç”¨è¯¥æœºåˆ¶ï¼Œå¯ä»¥æœ‰æ•ˆä¿æŠ¤ç³»ç»Ÿå®‰å…¨ï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹å’Œèº«ä»½ä¼ªé€ ç­‰å®‰å…¨å¨èƒã€‚

---

_æœ€åæ›´æ–°ï¼š2024 å¹´_  
_ç‰ˆæœ¬ï¼šv1.0_
